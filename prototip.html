<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BiliÅŸim Duyuru</title>

<style>
body{background:#121212;color:#fff;font-family:Arial;margin:0}
header{background:#1f1f1f;padding:15px;text-align:center}
.container{max-width:900px;margin:auto;padding:20px}
.box{background:#2a2a2a;padding:15px;margin:15px 0;border-radius:6px}
input,textarea,button{width:100%;margin:6px 0;padding:10px;border-radius:5px;border:none}
button{background:#28a745;color:#fff;cursor:pointer}
.small{font-size:12px;color:#aaa}
.comment{background:#3a3a3a;padding:8px;margin:5px 0;border-radius:4px}
.danger{background:#dc3545}
.logout{background:#ff9800}
</style>
</head>

<body>

<header>
<h1>BiliÅŸim SÄ±nÄ±fÄ± DuyurularÄ±</h1>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginBox" class="box">
<h3>GiriÅŸ Yap</h3>
<input id="email" placeholder="E-posta">
<input id="password" type="password" placeholder="Åžifre">
<button onclick="login()">GiriÅŸ</button>
<p id="loginErr" class="small"></p>
</div>

<!-- PANEL -->
<div id="panel" style="display:none">

<button class="logout" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</button>
<p id="welcome" class="small"></p>

<!-- OWNER PANEL -->
<div id="ownerPanel" class="box" style="display:none">
<h3>Yeni Duyuru</h3>
<input id="title" placeholder="BaÅŸlÄ±k">
<textarea id="content" placeholder="Ä°Ã§erik"></textarea>
<button onclick="addAnnouncement()">GÃ¶nder</button>
</div>

<div id="announcements"></div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  getDoc,
  updateDoc,
  deleteDoc,
  query,
  orderBy,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCGeT4GBftuRz6m86v-Yw8GeY4jS5KI3SE",
  authDomain: "bilisim-duyuru.firebaseapp.com",
  projectId: "bilisim-duyuru",
  storageBucket: "bilisim-duyuru.firebasestorage.app",
  messagingSenderId: "333818844996",
  appId: "1:333818844996:web:56b4b173a0ab3b3526e911"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let currentRole = "student";

/* LOGIN */
window.login = async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      email.value,
      password.value
    );
  } catch (e) {
    loginErr.innerText = e.message;
  }
};

/* LOGOUT */
window.logout = () => signOut(auth);

/* AUTH STATE */
onAuthStateChanged(auth, async user => {
  if (!user) {
    loginBox.style.display = "block";
    panel.style.display = "none";
    return;
  }

  currentUser = user;
  loginBox.style.display = "none";
  panel.style.display = "block";

  const uRef = doc(db, "users", user.uid);
  const snap = await getDoc(uRef);

  if (!snap.exists()) {
    await updateDoc(uRef, { banned:false, role:"student" })
      .catch(()=>{});
  }

  const data = snap.data();
  if (data?.banned) {
    alert("Bu hesap banlÄ±");
    logout();
    return;
  }

  currentRole = data?.role || "student";
  welcome.innerText = user.email + " (" + currentRole + ")";

  ownerPanel.style.display =
    currentRole === "owner" ? "block" : "none";

  loadAnnouncements();
});

/* ADD ANNOUNCEMENT */
window.addAnnouncement = async () => {
  if (currentRole !== "owner") return;

  await addDoc(collection(db, "announcements"), {
    title: title.value,
    content: content.value,
    author: currentUser.email,
    createdAt: serverTimestamp()
  });

  title.value = "";
  content.value = "";
  loadAnnouncements();
};

/* LOAD ANNOUNCEMENTS */
async function loadAnnouncements() {
  const q = query(
    collection(db, "announcements"),
    orderBy("createdAt", "desc")
  );

  const snap = await getDocs(q);
  announcements.innerHTML = "";

  snap.forEach(async d => {
    const a = d.data();

    let html = `
    <div class="box">
      <h3>${a.title}</h3>
      <div class="small">${a.author}</div>
      <p>${a.content}</p>`;

    if (currentRole === "owner") {
      html += `<button class="danger"
        onclick="deleteAnnouncement('${d.id}')">Sil</button>`;
    }

    html += `
      <h4>Yorumlar</h4>
      <div id="c_${d.id}"></div>
      <input id="i_${d.id}" placeholder="Yorum yaz">
      <button onclick="addComment('${d.id}')">GÃ¶nder</button>
    </div>`;

    announcements.innerHTML += html;

    loadComments(d.id);
  });
}

/* COMMENTS */
async function loadComments(aid) {
  const cRef = collection(db, "announcements", aid, "comments");
  const snap = await getDocs(cRef);
  const div = document.getElementById("c_"+aid);
  div.innerHTML = "";
  snap.forEach(c=>{
    div.innerHTML += `<div class="comment">${c.data().text}</div>`;
  });
}

window.addComment = async (aid) => {
  const input = document.getElementById("i_"+aid);
  if (!input.value) return;

  await addDoc(
    collection(db, "announcements", aid, "comments"),
    { text: input.value, author: currentUser.email }
  );
  input.value="";
  loadComments(aid);
};

window.deleteAnnouncement = async (id) => {
  if (confirm("Silinsin mi?"))
    await deleteDoc(doc(db,"announcements",id));
  loadAnnouncements();
};
</script>

</body>
</html>
